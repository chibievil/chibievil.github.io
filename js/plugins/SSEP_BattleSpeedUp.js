//=============================================================================
// sound sepher Engine - Battle Speed Up
// SSEP_BattleSpeedUp.js
// Version: 1.50
//=============================================================================

var Imported = Imported || {};
Imported.SSEP_BattleSpeedUp = true;

var Sepher = Sepher || {};

//=============================================================================
/*:
 * @plugindesc ????????????????????????????톋nflyEngine??????
 * ??????????YanflyEngine???????????????????>??
 * @author Shoichiro Sakamoto(sound sepher)
 *
 * @help
 * ------------------------------------------------------------------------------
 * ??sound sepher Engine - "Battle Speed UP" Plugin (Ver1.50 '15 10/29)
 * ------------------------------------------------------------------------------
 * ??????????????? / Shoichiro Sakamoto (sound sepher)
 * Web ?ttp://sepher.jp/
 * 
 * ------------------------------------------------------------------------------
 * ?????????
 * ------------------------------------------------------------------------------
 * ??????????????????????????????????????????
 * ???????????????????????????????????@????????
 * 
 * ??????anflyEngine??BattleCore?v????????????????????????(X_ActSeqPack1??)??
 * Ellye's Active Time Battle??????@????????
 * 
 * YanflyEngine??Ellye's ATB??????@??????'?v?????????????????????l??
 * ????????????????????????????????????????????&?????s??
 * ?????톖lye's ATB?????????108??a"(function() {"??550??a"})();"??????????
 * ????????????r???????????>??
 * 
 * ------------------------------------------------------------------------------
 * ??????
 * ------------------------------------------------------------------------------
 * OK????????????????????k??????'???vj????????????????
 * 
 * ??????????????r???????????k?????????????
 * ?????????????o??i????????v??????????????????????>??
 * ????????General Setting?????????????????????g???
 * 
 * ------------------------------------------------------------------------------
 * ??????????
 * ------------------------------------------------------------------------------
 * ????????????r????k??a????YanflyEngine???????????????????>??
 * ??????????>????s????????????????????????>??
 * ??????l??txt???????????????????????????r????@???????i??@??????
 * 
 * ------------------------------------------------------------------------------
 * ?????????????????
 * ------------------------------------------------------------------------------
 * ??BattleSpeed (Default)?K????????????????????????????????????
 * ??BattleSpeed (Boost)???K?????????????k???????????????????????
 * ?????????????????????? ??4????????????'??j????s??
 * ------------------------------------------------------------------------------
 * ??StateIcon???????????????????렁??????????????????????????????
 * ??StateOverLay???????? ?????????렁?????G??????G?????????????????
 * ??Weapon?????????????? ??????????????????????????????????????
 * ??Motion?????????????? ??????????????G??????????????????
 * ?????????????????????? ????????G?????????G???????????????????
 * ?????????????????????? ????????eapon??Motion????????????????
 * ?????????????????????? ????????????????'??????????
 * ??Balloon??????????????????????????????????
 * ??Damage?????????????? ?????????????????????????????????
 * ??DamageMin?????????????????????????????????????????????????????
 * ?????????????????????? ??Damage??????????????????>??????????????????
 * ------------------------------------------------------------------------------
 * ??LogAnime BaseDelay?? ???????????????????????????????????????
 * ??LogAnime NextDelay?? ???????????????????????????????????????
 * ??LogWaitCount Default ????????????????????????????????????????
 * ?????????????????????? ??????????????@??????
 * ??LogWaitCount Boost?? ????????????????????????????????????????
 * ?????????????????????? ??????????????@??????(??????????)
 * ?????????????????????? ????????????????????OK????????????????????k????
 * ?????????????????????? ?????????????%????????????
 * ------------------------------------------------------------------------------
 * ?????톉anflyEngine - BattleCore????????톕??????????@??????
 * 
 * ??YEP Battle MotionWait???????&???????????????????'????????????
 * ------------------------------------------------------------------------------
 * ?????텲llyeATB(Ellye's Active Time Battle)????????톕??????????@??????
 * 
 * ??ATB Speed(Default)???????텮T??????????????r????????@??????
 * ??ATB Speed(Boost)  ???????????AT??????????????r????????@??????
 * ------------------------------------------------------------------------------
 *
 * @param ---General Setting---
 * @default
 * @param BattleSpeed (Default)
 * @desc ????????????G?????????????????1??
 * ???????????????G??????????????????@??????
 * @default 1
 * @param BattleSpeed (Boost)
 * @desc ????(OK)???????????????G?????????????????2??
 * ???????????????G??????????????????@??????
 * @default 2
 * @param ---Detail Setting---
 * @default
 * @param StateIcon
 * @desc ???렁???????????????G??????r???@??????
 * ???????40??
 * @default 40
 * @param StateOverlay
 * @desc ???렁?????????????????G??????r???@????
 * ???????8??
 * @default 8
 * @param Weapon
 * @desc ????????????????????렁????G??????r???@??????
 * ???????12?톙tion???????????????????????v??
 * @default 12
 * @param Motion
 * @desc ???????????????????G??????r???@??????
 * ???????12?8eapon???????????????????????v??
 * @default 12
 * @param Balloon
 * @desc ?????????????G??????r???@??????
 * ???????12??
 * @default 12
 * @param Damage
 * @desc ???????????????렁????????????????????@??????
 * ???????90????????????????????????????????
 * @default 90
 * @param DamageMin
 * @desc ???????????????렁????????????????????????????@??????
 * ???????60??%?????????????????????????????????
 * @default 60
 * @param --BattleLog Setting--
 * @default
 * @param LogAnime BaseDelay
 * @desc ??????????????????????????????????????@??????
 * ???????8?톋ttleSpeed (Default)??????????????s??
 * @default 8
 * @param LogAnime NextDelay
 * @desc ??????????????????????????????????????@??????
 * ???????12?톋ttleSpeed (Default)??????????????s??
 * @default 12
 * @param LogWaitCount Default
 * @desc ?????????????????????????????????????????@??????
 * ???????1????????d??????????????????????렁???????
 * @default 1
 * @param LogWaitCount Boost
 * @desc ???????????????????????????????????????????@??????
 * ???????20????????d??????????????????????렁???????
 * @default 2
 * @param YEP Battle LogWait
 * @desc YEP BattleCore????????????????????????????
 * ???????20????????i??????????????????'????????????
 * @default 20
 * @param ---Ellye ATB---
 * @default
 * @param ATB Speed(Default)
 * @desc EllyeATB????????????????????????????
 * ???????1??????????텮T??????????????r????????@??????
 * @default 1
 * @param ATB Speed(Boost)
 * @desc EllyeATB????????????????????????????
 * ???????2????????????AT??????????????r????????@??????
 * @default 2
 *
 */

//------------------------------------------------------------------------------
// ????????????
//------------------------------------------------------------------------------

Sepher.Parameters = PluginManager.parameters('SSEP_BattleSpeedUp');
Sepher.Param = Sepher.Param || {};

Sepher.Param.BattleSpeedDefault	= String(Sepher.Parameters['BattleSpeed (Default)']);
Sepher.Param.BattleSpeedBoost	= String(Sepher.Parameters['BattleSpeed (Boost)']);
Sepher.Param.StateIcon			= String(Sepher.Parameters['StateIcon']);
Sepher.Param.StateOverlay		= String(Sepher.Parameters['StateOverlay']);
Sepher.Param.Weapon				= String(Sepher.Parameters['Weapon']);
Sepher.Param.Balloon			= String(Sepher.Parameters['Balloon']);
Sepher.Param.Motion				= String(Sepher.Parameters['Motion']);
Sepher.Param.Damage				= String(Sepher.Parameters['Damage']);
Sepher.Param.DamageMin			= String(Sepher.Parameters['DamageMin']);
Sepher.Param.LogBase			= String(Sepher.Parameters['LogAnime BaseDelay']);
Sepher.Param.LogNext			= String(Sepher.Parameters['LogAnime NextDelay']);
Sepher.Param.logWaitDefault		= String(Sepher.Parameters['LogWaitCount Default']);
Sepher.Param.logWaitBoost		= String(Sepher.Parameters['LogWaitCount Boost']);
Sepher.Param.YEPMotionWait		= String(Sepher.Parameters['YEP Battle MotionWait']);
Sepher.Param.ATBSpeedDefault	= String(Sepher.Parameters['ATB Speed(Default)']);
Sepher.Param.ATBSpeedBoost		= String(Sepher.Parameters['ATB Speed(Boost)']);

//------------------------------------------------------------------------------
// QuickMode Speed Setting
//------------------------------------------------------------------------------

Sprite_StateIcon.prototype.animationWait = function() {
	var speed = Sepher.Param.StateIcon / Sepher.Param.BattleSpeedDefault;
    return speed;
};

Sprite_StateOverlay.prototype.animationWait = function() {
	var speed = Sepher.Param.StateOverlay / Sepher.Param.BattleSpeedDefault;
    return speed;
};

Sprite_Weapon.prototype.animationWait = function() {
	var speed = Sepher.Param.Weapon / Sepher.Param.BattleSpeedDefault;
	if (Input.isPressed('ok') || TouchInput.isPressed()){
		speed = speed / Sepher.Param.BattleSpeedBoost;
	} else {
		speed = speed / Sepher.Param.BattleSpeedDefault;
	}
   	return speed;
};

Sprite_Balloon.prototype.waitTime = function() {
	var speed = Sepher.Param.Balloon / Sepher.Param.BattleSpeedDefault;
	if (Input.isPressed('ok') || TouchInput.isPressed()){
		speed = speed / Sepher.Param.BattleSpeedBoost;
	} else {
		speed = speed / Sepher.Param.BattleSpeedDefault;
	}
    return speed;
};

// Alias - startMove
var _SSEP_Battler_startMove = Sprite_Battler.prototype.startMove;
Sprite_Battler.prototype.startMove = function(x, y, duration) {
	if (Input.isPressed('ok') || TouchInput.isPressed()){
  		duration = duration / Sepher.Param.BattleSpeedBoost;
  	} else {
  		duration = duration / Sepher.Param.BattleSpeedDefault;
	}
	_SSEP_Battler_startMove.call(this, x, y, duration);
};


Sprite_Actor.prototype.motionSpeed = function() {
	var speed = Sepher.Param.Motion;
	if (Input.isPressed('ok') || TouchInput.isPressed()){
		speed = speed / Sepher.Param.BattleSpeedBoost;
	} else {
		speed = speed / Sepher.Param.BattleSpeedDefault;
	}
    return speed;
};

// Alias - Animation setup
var _SSEP_Animation_setup = Sprite_Animation.prototype.setup;
Sprite_Animation.prototype.setup = function(target, animation, mirror, delay) {
	delay = delay / Sepher.Param.BattleSpeedDefault;
	if (Input.isPressed('ok') || TouchInput.isPressed()){
		delay = delay / Sepher.Param.BattleSpeedBoost;
	} else {
		delay = delay / Sepher.Param.BattleSpeedDefault;
	}
	_SSEP_Animation_setup.call(this, target, animation, mirror, delay);
};


// Alias - Animation_setupRate
var _SSEP_Animation_setupRate = Sprite_Animation.prototype.setupRate;
Sprite_Animation.prototype.setupRate = function() {
    _SSEP_Animation_setupRate;
	if (Input.isPressed('ok') || TouchInput.isPressed()){
		this._rate = this._rate / Sepher.Param.BattleSpeedBoost;
	} else {
	    this._rate = this._rate / Sepher.Param.BattleSpeedDefault;
	}
	this._rate = (Math.round(this._rate));
	if (this._rate < 1){
		this._rate = 1;
	}
};


var _SSEP_Damage_initialize = Sprite_Damage.prototype.initialize;
Sprite_Damage.prototype.initialize = function() {
	_SSEP_Damage_initialize.call(this);
    this._duration = Sepher.Param.Damage;
	if (Input.isPressed('ok') || TouchInput.isPressed()){
		this._duration = this._duration / Sepher.Param.BattleSpeedBoost;
	} else {
		this._duration = this._duration / Sepher.Param.BattleSpeedDefault;
	}
    if (this._duration <= Sepher.Param.DamageMin){
    	this._duration = Sepher.Param.DamageMin;
    }
};

// BattleLog Window
Window_BattleLog.prototype.animationBaseDelay = function() {
	var speed = Sepher.Param.LogBase;
    return speed;
};

Window_BattleLog.prototype.animationNextDelay = function() {
	var speed = Sepher.Param.LogNext;
    return speed;
};

Window_BattleLog.prototype.updateWaitCount = function() {
	var waitMax;
	var waitMin;
	if (Input.isPressed('ok') || TouchInput.isPressed()){
   	    waitMax = 3 * Sepher.Param.logWaitBoost;
    	waitMin = 1 * Sepher.Param.logWaitBoost;
   	}else{
   	    waitMax = 3 * Sepher.Param.logWaitDefault;
    	waitMin = 1 * Sepher.Param.logWaitDefault;
	}

    if (this._waitCount > 0) {
        this._waitCount -= this.isFastForward() ? waitMax : waitMin;
        if (this._waitCount < 0) {
            this._waitCount = 0;
        }
    	return true;
    }
    return false;
};

//------------------------------------------------------------------------------
//??????? Yanfly Engine BattleCore
//------------------------------------------------------------------------------

if (Imported.YEP_BattleEngineCore){

	//Overwrite actionPerformAction
	BattleManager.actionPerformAction = function() {
		wait = Sepher.Param.YEPMotionWait;
		if (Input.isPressed('ok') || TouchInput.isPressed()){
			wait = wait / Sepher.Param.BattleSpeedBoost;
		} else {
			wait = wait / Sepher.Param.BattleSpeedDefault;
		}
				
	    this._logWindow.performAction(this._subject, this._action);
			if (this._subject.isActor() && this._subject.isSpriteVisible) {
				this._logWindow._waitCount += wait;
				return false;
			}
 	   return true;
	};

	//Overwrite actionFloat
	BattleManager.actionFloat = function(name, actionArgs) {
		var movers = this.makeActionTargets(name);
		if (movers.length < 1) return true;
		var cmd = actionArgs[0];
		var frames = actionArgs[1] || 12;

		if (Input.isPressed('ok') || TouchInput.isPressed()){
			frames = frames / Sepher.Param.BattleSpeedBoost;
		} else {
			frames = frames / Sepher.Param.BattleSpeedDefault;
		}
		
	    var pixels = 0;
	    if (cmd.match(/(\d+)([%렁)/i)) {
	    	var floatPeak = parseFloat(RegExp.$1 * 0.01);
		} else if (cmd.match(/(\d+)/i)) {
			pixels = parseInt(RegExp.$1);
			var floatPeak = 0.0;
    	} else {
    		var floatPeak = 1.0;
    	}
    	movers.forEach(function(mover) {
    		var floatRate = floatPeak + (pixels / mover.spriteHeight());
    		mover.spriteFloat(floatRate, frames);
    	});
    	return false;
	};

	//Overwrite actionJump
	BattleManager.actionJump = function(name, actionArgs) {
	    var movers = this.makeActionTargets(name);
	    if (movers.length < 1) return true;
	    var cmd = actionArgs[0];
	    var frames = actionArgs[1] || 12;

		if (Input.isPressed('ok') || TouchInput.isPressed()){
			frames = frames / Sepher.Param.BattleSpeedBoost;
		} else {
			frames = frames / Sepher.Param.BattleSpeedDefault;
		}
		
	    var pixels = 0;
		if (cmd.match(/(\d+)([%렁)/i)) {
			var jumpPeak = parseFloat(RegExp.$1 * 0.01);
    	} else if (cmd.match(/(\d+)/i)) {
    		pixels = parseInt(RegExp.$1);
    		var jumpPeak = 0.0;
    	} else {
    		var jumpPeak = 1.0;
    	}
    	movers.forEach(function(mover) {
    		var jumpRate = jumpPeak + (pixels / mover.spriteHeight());
    		mover.spriteJump(jumpRate, frames);
    	});
    	return true;
    };
}

//------------------------------------------------------------------------------
// Support Ellye's ATB
//------------------------------------------------------------------------------

//Check if there is Window_CTB function
if (typeof Window_CTB == "function"){
    //Changing the flow of battle
    //_BattleManager_update=BattleManager.update;
    BattleManager.update=function() {
        if(!this.isBusy()&&!this.updateEvent()) {
            switch(this._phase) {
                case 'atb':
                	//Add script
                	if (Input.isPressed('ok') || TouchInput.isPressed()){
                		console.log(Sepher.Param.ATBSpeedBoost);
	                	var speed = Sepher.Param.ATBSpeedBoost;
	                }else{
                		console.log(Sepher.Param.ATBSpeedDefault);
	                	var speed = Sepher.Param.ATBSpeedDefault;
	                }
                    this.increaseAtbGauges(speed);
                    break;
                default:
                    _BattleManager_update.call(this);
                    break;
            }
        }
    };
    //Increases the ATB gauges when idle:
    BattleManager.increaseAtbGauges=function(speed) {
    	//Add variable
        var base_atb_increase_ex = base_atb_increase * speed;

        turn_atb+=(base_atb_increase_ex+turn_timer*(agi_weight/100));
        if(turn_atb>=full_atb) {
            turn_atb-=full_atb;
            $gameTroop.increaseTurn();
            if(end_of_turn_effects!==0) {
                this.allBattleMembers().forEach(function(battler) {
                    battler.onTurnEnd();
                    this.refreshStatus();
                    this._logWindow.displayAutoAffectedStatus(battler);
                    this._logWindow.displayRegeneration(battler);
                },this);
            }
        }
        this.allBattleMembers().forEach(function(battler) {
            if(battler.isDead()) {
                battler.atb=0;
            }
            else {
                battler.atb+=(base_atb_increase_ex+battler.agi*(agi_weight/100));
            }
            if(battler.atb>=full_atb) {
                this.battlerHasFullAtb(battler);
            }
        },this);
        this.refreshStatus();
    };
}
